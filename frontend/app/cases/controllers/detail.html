<div ng-if="!vm.case.id" ng-include="'utils/controllers/does_not_exist.html'" class="row">
</div>

<div class="row">
    <div class="col-md-8">
        <div class="widget-container" ng-if="vm.case.id">
            <div class="widget-heading">
                <div class="hl-button-group-container">
                    <ul class="hl-button-group" data-toggle="buttons" data-object-id="{{ ::vm.case.id }}">
                        <li class="hl-button-group-btn" ng-repeat="status in vm.caseStatuses" ng-click="vm.changeCaseStatus(status)" ng-class="{'selected': vm.case.status.name == status.name, 'disabled': vm.case.is_archived }">
                            <span class="hl-button-group-btn-link">
                                {{ status.name }}
                            </span>
                        </li>

                        <li class="hl-button-group-btn">
                            <span class="hl-button-group-btn-link" ng-click="vm.case.is_archived = !vm.case.is_archived">
                                <span ng-if="vm.case.is_archived">Unarchive</span>
                                <span ng-if="!vm.case.is_archived">Archive</span>
                            </span>
                        </li>
                    </ul>
                </div>

                <div class="clearfix"></div>
            </div>
            <div class="widget-body">
                <table class="widget-table align-table">
                    <tbody>
                        <tr>
                            <td><strong>Case ID:</strong> #{{ vm.case.id }}</td>
                            <td>
                                <strong>Type:</strong>
                                <editable-select class="margin-left-10" field="type" view-model="vm" type="Case" select-options="{field: 'caseTypes'}">
                                    {{ vm.case.type.name }}
                                </editable-select>
                            </td>
                            <td>
                                <strong>Priority:</strong>
                                <editable-select class="margin-left-10" field="priority" view-model="vm" type="Case" choice-field="true" select-options="{field: 'casePriorities'}">
                                    <span class="lilicon" ng-class="{0: 'hl-low-prio-icon', 1: 'hl-normal-prio-icon', 2: 'hl-high-prio-icon', 3: 'hl-critical-prio-icon'}[vm.case.priority]"></span>
                                    {{ vm.case.priority_display }} priority
                                </editable-select>
                            </td>
                            <td><strong>Expires on:</strong> <postpone class="margin-left-5" type="'Case'" object="vm.case" date-field="'expires'"></postpone></td>
                        </tr>
                    </tbody>
                </table>
                <div class="widget-content">
                    <strong>Description <i class="lilicon hl-edit-icon clickable margin-left-10" ng-click="descriptionForm.$show()" ng-hide="descriptionForm.$visible"></i></strong>
                    <div class="pre-wrap" editable-textarea="vm.case.description" e-rows="4" e-cols="100" e-form="descriptionForm" onbeforesave="vm.updateModel($data, 'description')" ng-bind-html="(vm.case.description | parseUrls) || 'No description'"></div>
                </div>
            </div>
        </div>

        <checkbox model="vm.mergeHistory" class="pull-right">Merge history lists</checkbox>

        <span ng-if="vm.mergeHistory">
            <history-list ng-if="vm.case.id" target="'case'" object="vm.case" extra-object="{object: vm.case.account, target: 'account'}" date-start="vm.caseStart" date-end="vm.caseEnd"></history-list>
        </span>

        <span ng-if="!vm.mergeHistory">
            <history-list ng-if="vm.case.id" target="'case'" object="vm.case"></history-list>
            <history-list ng-if="vm.case.account.id" target="'account'" object="vm.case.account" date-start="vm.caseStart" date-end="vm.caseEnd" parent-object="vm.case"></history-list>
        </span>
    </div>

    <div ng-if="vm.case.id" class="col-md-4">
        <widget ng-if="vm.case.account" widget-name="'Account info'">
            <widget-header>
                <div class="widget-name">
                    <a ui-sref="base.accounts.detail({ id: vm.case.account.id })">
                        <i class="lilicon hl-company-icon"></i>
                        {{ vm.case.account.name }}
                    </a>
                </div>
            </widget-header>

            <widget-body>
                <div class="widget-content">
                    <table class="widget-content-table">
                        <tbody>
                            <tr ng-if="vm.case.account.email_addresses.length">
                                <td>E-mail</td>
                                <td>
                                    <ul>
                                        <li ng-repeat="email in vm.case.account.email_addresses">
                                            <a ui-sref="base.email.composeEmail({email: email.email_address})">{{ email.email_address }}</a> ({{ email.status_name }})
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                            <tr ng-if="vm.case.account.phone_numbers.length">
                                <td>Phone numbers</td>
                                <td>
                                    <ul>
                                        <li ng-repeat="phonenumber in vm.case.account.phone_numbers">
                                            <a href="tel:{{ phonenumber.number }}">{{ phonenumber.number }}</a> ({{phonenumber.type}})
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                            <tr ng-if="vm.case.account.addresses.length">
                                <td>Addresses</td>
                                <td>
                                    <ul ng-repeat="address in vm.case.account.addresses">
                                        <li>
                                            {{ address.address }}
                                        </li>
                                        <li>
                                            {{ address.postal_code }}, {{ address.city }}
                                        </li>
                                        <li>
                                            {{ address.country_display }}
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                            <tr ng-if="vm.case.account.websites.length">
                                <td>Websites</td>
                                <td>
                                    <ul>
                                        <li ng-repeat="website in vm.case.account.websites">
                                            <a target="_blank" href="{{website.website}}">{{ website.website | stripScheme }}</a>
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                            <tr ng-if="vm.case.parcel_identifier">
                                <td>Shipment</td>
                                <td><a href="{{ vm.case.parcel_link }}">Track this parcel</a></td>
                            </tr>
                            <tr ng-if="vm.case.account.customer_id && vm.tenant.primary_external_app_link">
                                <td>External</td>
                                <td>
                                    <a ng-href="{{ vm.tenant.primary_external_app_link.getUrl(vm.case.account.customer_id) }}" target="_blank">
                                        <i class="fa fa-external-link fa-sm"></i>
                                        {{ vm.tenant.primary_external_app_link.name }}
                                    </a>
                                </td>
                            </tr>
                            <tr class="has-no-info" ng-if="!vm.case.account.email_addresses.length && !vm.case.account.phone_numbers.length && !vm.case.account.addresses.length && !vm.case.account.websites.length && !vm.case.parcel_identifier" >
                                <td>No additional information</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </widget-body>
        </widget>

        <widget ng-if="vm.case.contact" widget-name="'Contact info'">
            <widget-header>
                <div class="widget-name">
                    <a ui-sref="base.contacts.detail({ id: vm.case.contact.id })">
                        <i class="lilicon hl-user-icon"></i>
                        {{ vm.case.contact.full_name }}
                    </a>
                </div>
            </widget-header>

            <widget-body>
                <div class="widget-content">
                    <table class="widget-content-table">
                        <tbody>
                            <tr ng-if="vm.case.contact.email_addresses.length">
                                <td>E-mail addresses</td>
                                <td>
                                    <ul>
                                        <li ng-repeat="email in vm.case.contact.email_addresses">
                                            <a ui-sref="base.email.composeEmail({email: email.email_address})">{{ email.email_address }}</a> ({{ email.status_name }})
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                            <tr ng-if="vm.case.contact.phone_numbers.length">
                                <td>Phone numbers</td>
                                <td>
                                    <ul>
                                        <li ng-repeat="phonenumber in vm.case.contact.phone_numbers">
                                            <a href="tel:{{ phonenumber.number }}">{{ phonenumber.number }}</a> ({{phonenumber.type}})
                                        </li>
                                    </ul>
                                </td>
                            </tr>

                            <tr class="has-no-info" ng-if="!vm.case.contact.email_addresses.length && !vm.case.contact.phone_numbers.length">
                                <td>No additional information</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </widget-body>
        </widget>

        <widget widget-name="'More info'">
            <widget-header>
                <div class="widget-name">
                    <i class="fa fa-info"></i>
                    More info
                </div>
            </widget-header>

            <widget-body>
                <div class="widget-content case-detail-info">
                    <table class="widget-content-table">
                        <tbody>
                            <tr>
                                <td>Assigned to</td>
                                <td>
                                    <editable-select field="assigned_to" view-model="vm" type="Case" search="true" select-options="{type: 'User', display: 'full_name', placeholder: 'Assign to...', allowClear: true}">
                                        {{ vm.case.assigned_to.full_name || 'Nobody'}}
                                    </editable-select>
                                    <a ng-if="vm.case.assigned_to.id != currentUser.id" ng-click="vm.assignCase()">
                                        <i class="fa fa-anchor margin-left-5"></i> Assign to me
                                    </a>
                                </td>
                            </tr>
                            <tr ng-if="vm.case.assigned_to_groups.length">
                                <td>Assigned to teams:</td>
                                <td>{{ vm.case.assigned_to_groups | join:'name' }}</td>
                            </tr>

                            <tr><td>Created by</td> <td>{{ vm.case.created_by.full_name || 'Unknown' }}</td></tr>
                            <tr><td>Created on</td> <td>{{ vm.case.created | date:"dd MMMM y H:mm" }}</td></tr>

                            <tr>
                                <td>Expires on</td>
                                <td><postpone type="'Case'" object="vm.case" date-field="'expires'"></postpone></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </widget-body>
        </widget>

        <widget widget-name="'Tags'">
            <widget-header>
                <div class="widget-name">
                    <i class="fa fa-tag"></i>
                    Tags
                </div>
            </widget-header>

            <widget-body>
                <div class="widget-content">
                    <editable-tags view-model="vm" type="Case"></editable-tags>
                </div>
            </widget-body>
        </widget>
    </div>
</div>
