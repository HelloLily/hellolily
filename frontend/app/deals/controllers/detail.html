<div ng-if="!vm.deal.id" ng-include="'utils/controllers/does_not_exist.html'" class="row">
</div>
<div ng-if="vm.deal.id" class="row">
    <div class="col-md-6">
      <div class="portlet light">
            <div class="portlet-body">
                <div class="row">
                    <div class="col-md-12 deal-detail-info">
                        <div ng-if="vm.deal.account">
                            <label>Account</label>
                            <a ui-sref="base.accounts.detail({ id: vm.deal.account.id })">
                                {{ vm.deal.account.name }}
                            </a>
                        </div>
                        <div ng-if="vm.deal.contact">
                            <label>Contact</label>
                            <a ui-sref="base.contacts.detail({ id: vm.deal.contact.id })">
                                {{ vm.deal.contact.name }}
                            </a>
                        </div>
                        <div>
                            <label>Deal name</label>
                            <span editable-text="vm.deal.name" blur="submit" onbeforesave="vm.updateModel($data, 'name')">{{ vm.deal.name }}</span>
                        </div>
                        <div>
                            <label>Found us through</label>
                            <editable-select field="found_through" view-model="vm" type="Deal" choice-field="true">
                                {{ vm.deal.found_through_display }}
                            </editable-select>
                        </div>
                        <div>
                            <label>Contacted us by</label>
                            <editable-select field="contacted_by" view-model="vm" type="Deal" choice-field="true">
                                {{ vm.deal.contacted_by_display }}
                            </editable-select>
                        </div>
                        <div>
                            <label>Why customer</label>
                            <editable-select field="why_customer" view-model="vm" type="Deal">
                                {{ vm.deal.why_customer.name }}
                            </editable-select>
                        </div>
                        <div>
                            <label>Next step</label>
                            <editable-select field="next_step" view-model="vm" type="Deal">
                                <span class="step-type" id="next-step" ng-if="vm.deal.next_step" ng-class="{0: 'position-1', 1: 'position-2', 2: 'position-3', 3: 'position-4', 4: 'position-5', 5: 'position-6'}[vm.deal.next_step.position]">
                                    {{ vm.deal.next_step.name }}
                                </span>
                            </editable-select>
                        </div>
                        <div ng-if="vm.deal.next_step_date">
                            <label>Next step date</label>
                            <postpone type="'Deal'" object="vm.deal" date-field="'next_step_date'" tt-placement="bottom" display-date="true"></postpone>
                        </div>
                        <div ng-if="vm.deal.closed_date">
                            <label>Closed date</label>
                            <span id="closed-date">
                                <date date="vm.deal.closed_date"></date>
                            </span>
                        </div>
                        <div>
                            <label>Created</label>
                             <date date="vm.deal.created"></date>
                        </div>
                        <div>
                            <label>Created by</label>
                             {{ ::vm.deal.created_by.full_name }}
                        </div>
                   </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="portlet light">
            <div class="portlet-body">
                <div class="row">
                    <div class="col-md-12 deal-detail-info">
                        <div>
                            <label>Assigned to</label>
                            <editable-select field="assigned_to" view-model="vm" type="Deal" select-options="{type: 'User', field: 'assignOptions', display: 'full_name'}">
                                {{ vm.deal.assigned_to.full_name }}
                            </editable-select>
                        </div>
                        <div>
                            <label>One-time cost</label>
                            <span editable-text="vm.deal.amount_once" onbeforesave="vm.updateModel($data, 'amount_once')" blur="submit">{{ vm.deal.amount_once | currency:"€" }}</span>
                        </div>
                        <div>
                            <label>Recurring costs</label>
                            <span editable-text="vm.deal.amount_recurring" onbeforesave="vm.updateModel($data, 'amount_recurring')" blur="submit">{{ vm.deal.amount_recurring | currency:"€" }}</span>
                        </div>
                        <div>
                            <label>Status</label>
                            <span ng-if="vm.deal.is_archived">{{ vm.deal.stage_display }}</span>
                            <editable-select ng-if="!vm.deal.is_archived" field="stage" view-model="vm" type="Deal" choice-field="true">
                                {{ vm.deal.stage_display }}
                            </editable-select>
                            <span ng-show="vm.deal.is_archived">- Archived</span>
                        </div>
                        <div>
                            <label>Twitter checked</label>
                            <editable-checkbox view-model="vm" type="Deal" field="twitter_checked"></editable-checkbox>
                        </div>
                        <div ng-show="vm.deal.stage == 2">
                            <label>Quote checked</label>
                            <editable-checkbox view-model="vm" type="Deal" field="is_checked"></editable-checkbox>
                        </div>
                        <div>
                            <label>Card sent</label>
                            <editable-checkbox view-model="vm" type="Deal" field="card_sent"></editable-checkbox>
                        </div>
                        <div>
                            <label>Feedback form sent</label>
                            <editable-checkbox view-model="vm" type="Deal" field="feedback_form_sent"></editable-checkbox>
                        </div>
                        <div ng-show="vm.deal.tag">
                            <label>Tags</label>

                            <span class="btn btn-xs btn-default margin-right-5" ng-repeat="tag in vm.deal.tag">
                                {{ tag }}
                            </span>
                        </div>
                        <div ng-show="vm.deal.quote_id || vm.deal.account_customer_id">
                            <label>External</label>
                            <a ng-show="vm.deal.quote_id" ng-href="https://freedom.voys.nl/quotes/pdf/{{ vm.deal.quote_id }}/">Quote</a>
                            <span ng-show="vm.deal.quote_id && vm.deal.account_customer_id">|</span>
                            <a ng-href="https://freedom.voys.nl/client/{{ vm.deal.account_customer_id }}" ng-if="vm.deal.account_customer_id">Environment</a>
                        </div>
                   </div>
                </div>
            </div>
        </div>
    </div>
</div>
<hr />
<div ng-if="vm.deal.id" class="row">
    <div class="col-md-12 summary-info text-center">
        <div id="deal-stage" class="btn-group" data-toggle="buttons" data-object-id="{{ vm.deal.id }}">
                <label ng-repeat="stage in vm.dealStages" for="stage-{{ stage[1] | lowercase }}" ng-class="{'btn default': true, 'btn default active': vm.deal.stage == stage[0], 'btn default disabled': vm.deal.is_archived }" ng-click="vm.changeState(stage)">
                    <input class="toggle" type="radio" id="stage-{{ stage[1] | lowercase }}" name="radio" value="{{ stage[0] }}" ng-checked="vm.deal.stage == stage[0]">
                    {{ stage[1] }}
                </label>
            <div class="btn-group">
                <button class="btn default" ng-click="vm.deal.is_archived = !vm.deal.is_archived">
                    <span ng-if="vm.deal.is_archived">Unarchive</span>
                    <span ng-if="!vm.deal.is_archived">Archive</span>
                </button>
            </div>
        </div>
    </div>
</div>
<hr />
<div ng-if="vm.deal.id" class="row no-margin">
    <div class="well well-md">
        <h4>Description <i class="fa fa-pencil clickable margin-left-10" ng-click="descriptionForm.$show()" ng-hide="descriptionForm.$visible"></i></h4>
        <p editable-textarea="vm.deal.description" e-rows="4" e-cols="100" e-form="descriptionForm" onbeforesave="vm.updateModel($data, 'description')"
           class="pre-wrap" ng-bind-html="(vm.deal.description | parseUrls) || 'No description'">
        </p>
    </div>
</div>
<history-list ng-if="vm.deal.id" target="'deal'" object="vm.deal"></history-list>
