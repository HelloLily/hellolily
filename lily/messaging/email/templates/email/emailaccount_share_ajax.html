{% load i18n bootstrap3 %}

<form class="form form-horizontal" action="{% url messaging_email_account_share_template pk=form.instance.email.id %}" method="post" data-async role="form">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4>{% trans 'Share e-mail account' %}</h4>
    </div>
    <div class="modal-body">
        {% csrf_token %}

        <div class="form-body">
            {% block form-fields %}
                <div class="form-group">
                    <label class="col-md-3 control-label">Shared with</label>
                    <div class="col-md-9">
                        <div class="btn-group" data-toggle="buttons">
                            {% for radio in form.shared_with %}
                                <label class="btn btn-primary" for="{{ radio.id_for_label }}">
                                    {{ radio.choice_label }}
                                    {{ radio.tag }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {% bootstrap_field form.user_group layout="horizontal" field_class="col-md-9" label_class="col-md-3" %}
            {% endblock %}
        </div>
        <div data-async-response></div>
    </div>
    <div class="modal-footer">
        <button type="button" data-dismiss="modal" class="btn btn-default">{% trans 'Cancel' %}</button>
        <button type="submit" class="btn btn-primary" data-loading-text="<i class='icon-spinner icon-spin icon-large'></i> {% trans 'Sending..' %}">{% trans 'Continue' %}</button>
    </div>
</form>

<script>
(function() {
    function update_user_group() {
        $('#emailaccount-share .btn-group label').button();

        var user_group = $('#emailaccount-share [name="user_group"]').closest('.form-group')
        if($('#emailaccount-share [name="shared_with"]:checked').val() < 2) {
            $(user_group).hide();
        } else {
            $(user_group).show();
        }
    }

    /* on change */
    $('#emailaccount-share [name="shared_with"]').change(update_user_group);

    /* on load */
    update_user_group();

    /* highlight selected btn */
    $('#emailaccount-share .btn-group .btn').each(function() {
        if($(this).find('input:checked').length) {
            $(this).button('toggle');
        }
    });

    // FIXME: enable select2 for field *user_group*
    // FIXME: this script is not executing in case of form_invalid!
})();
</script>
