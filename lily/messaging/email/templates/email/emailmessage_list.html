{% extends 'email/emailmessage_base.html' %}

{% load i18n email %}

{% block inbox %}
<div class="col-md-10 emailmessage-list">
    <div class="inbox-header">
        <h1 class="pull-left">{{ folder_name }} {% if active_email_address %}<small>{% trans 'in' %} {{ active_email_address }}</small>{% endif %} {% if search_key %}<small>{% blocktrans count counter=page_obj.paginator.count %}with {{ counter }} result for `{{ search_key }}`{% plural %}with {{ counter }} results for `{{ search_key }}`{% endblocktrans %}</small>{% endif %}</h1>
        <form class="form-inline pull-right search-form" method="post" action="{{ search_action_url }}">
            {% csrf_token %}
            <div class="input-group input-medium">
                <input type="text" class="form-control" name="search_key" placeholder="{% trans 'Search..' %}" value="{{ search_key }}">
                <span class="input-group-btn">
                    <button type="submit" class="btn green" data-loading-text="<i class='icon-spin icon-spinner'></i>"><i class="icon-search"></i></button>
                </span>
            </div>
        </form>
    </div>
    <div class="inbox-loading">
        <i class="icon-spinner icon-spin"></i> {% trans 'Loading..' %}
    </div>
    <div class="inbox-content">
        <table class="table table-striped table-advance table-hover">
            <thead>
                <tr>
                    <th colspan="2">
                        <input type="checkbox" class="mail-checkbox mail-group-checkbox" data-set=".inbox .mail-checkbox">
                        <div class="btn-group">
                            <button class="btn btn-sm blue mail-actions" data-toggle="dropdown" data-loading-text="{% trans 'Actions' %} <i class='icon-spinner icon-spin'></i>">
                                {% trans 'Actions' %}
                                <i class="icon-angle-down"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <form action="{% url 'messaging_mark_read' %}" method="post" id="mark-read-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="ids[]" value="{{ object.id }}" class="bulk-ids">
                                    </form>
                                    <a href="{% url 'messaging_mark_read' %}" data-form-submit data-form-selector="#mark-read-form"><i class="icon-fixed-width"></i> {% trans 'Mark as read' %}</a>
                                </li>
                                <li>
                                    <form action="{% url 'messaging_mark_unread' %}" method="post" id="mark-unread-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="ids[]" value="{{ object.id }}" class="bulk-ids">
                                    </form>
                                    <a href="{% url 'messaging_mark_unread' %}" data-form-submit data-form-selector="#mark-unread-form"><i class="icon-fixed-width"></i> {% trans 'Mark as unread' %}</a>
                                </li>
                                {% if move_to_folders.items|length %}
                                <li class="dropdown-submenu">
                                    <form action="{% url 'move_messages_view' %}" method="post" id="move-messages-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="ids[]" value="{{ object.id }}" class="bulk-ids">
                                    <input type="hidden" name="folder" value="">
                                    </form>
                                    <a href="javascript:;"><i class="icon-fixed-width"></i> {% trans 'Move to' %}</a>
                                    <ul class="dropdown-menu">
                                        {% for value, label in move_to_folders.items %}
                                        <li {% if active_move_to_folder == value %}class="active"{% endif %}><a href="#" data-folder="{{ value }}">{{ label }}</a></li>
                                        {% endfor %}
                                    </ul>
                                <li>
                                {% else %}
                                <li class="disabled">
                                    <a href="javascript:;"><i class="icon-fixed-width"></i> {% trans 'Move to' %}</a>
                                </li>
                                {% endif %}
                                <li class="divider"></li>
                                <li>
                                    <form action="{% url 'messaging_move_trash' %}" method="post" id="move-trash-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="ids[]" value="{{ object.id }}" class="bulk-ids">
                                    </form>
                                    <a href="{% url 'messaging_move_trash' %}" data-form-submit data-form-selector="#move-trash-form"><i class="icon-trash"></i> {% trans 'Delete' %}</a>
                                </li>
                            </ul>
                        </div>
                    </th>
                    <th class="pagination-control" colspan="3">
                        <span class="pagination-info">{{ page_obj.start_index }}-{{ page_obj.end_index }} {% trans 'of' %} {{ page_obj.paginator.count }}</span>
                        {% if page_obj.has_previous %}
                        <a href="{{ request.path }}?page={{ page_obj.previous_page_number }}" class="btn btn-sm blue"><i class="icon-angle-left"></i></a>
                        {% endif %}
                        {% if page_obj.has_next %}
                        <a href="{{ request.path }}?page={{ page_obj.next_page_number }}" class="btn btn-sm blue"><i class="icon-angle-right"></i></a>
                        {% endif %}
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for object in object_list %}
                    <tr {% if not object.is_seen %}class="unread"{% endif %} data-href="{% if object.is_draft %}{% url 'messaging_email_compose' pk=object.pk %}{% else %}{% url 'messaging_email_detail' object.pk %}{% endif %}">
                        <td class="inbox-small-cells">
                            <input type="checkbox" class="mail-checkbox" value="{{ object.id }}">
                        </td>
                        <td class="view-message hidden-xs">{{ object.from_combined }}</td>
                        <td class="view-message">{{ object.subject|default:_('&lt;No subject&gt;') }}</td>
                        <td class="view-message inbox-small-cells">
                            {% if object.num_attachments > 0 %}<i class="icon-paper-clip"></i>{% endif %}
                        </td>
                        <td class="view-message text-right"><abbr title="{{ object.sent_date|pretty_datetime:'%d %B %Y %H:%M' }}">{{ object.sent_date|pretty_datetime }}</abbr></td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5">{% trans 'There are no messages in this folder.' %}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
$('[data-form-submit], #move-messages-form .dropdown-menu a').click(function() {
    // waiting for response from server so a redirect will 'unblock' the UI
    $('.mail-actions').button('loading');
    App.blockUI($('.inbox-content'), false, '');
});

$('#move-messages-form').closest('li').find('.dropdown-menu a').click(function() {
    // waiting for response from server so a redirect will 'unblock' the UI
    $('.mail-actions').button('loading');
    App.blockUI($('.inbox-content'), false, '');

    $('#move-messages-form').find('[name=folder]').val($(this).data('folder'));
    $('#move-messages-form').submit();
});
</script>
{% endblock %}
